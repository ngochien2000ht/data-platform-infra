services:
  minio:
    image: minio/minio:RELEASE.2022-10-24T18-35-07Z
    container_name: minio
    ports:
      - "${MINIO_PORT_API}:9000"
      - "${MINIO_PORT_UI}:9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    volumes:
      - minio-data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    restart: always
    networks:
      - bigdata-net
  
  mc:
    image: minio/mc:RELEASE.2022-10-29T10-09-23Z
    container_name: minio-mc
    depends_on:
      - minio
    volumes:
      - ${CONFIG_PATH}/minio:/docker-entrypoint-init.d:ro
    entrypoint: ["/bin/sh", "-c"]
    command: |
      "sleep 10;
      while ! mc alias set myminio http://minio:9000 $${MINIO_ROOT_USER} $${MINIO_ROOT_PASSWORD}; do
        echo waiting for minio;
        sleep 3;
      done;
      mc admin info myminio;
      /docker-entrypoint-init.d/init_minio.sh
      "
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    networks:
      - bigdata-net

volumes:
  minio-data:

networks:
  bigdata-net:
    external: true